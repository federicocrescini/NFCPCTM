<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Presence System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .status-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 30px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
            transition: all 0.5s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .status-circle.waiting {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .status-circle.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            animation: pulse 1.5s ease-in-out;
        }

        .status-circle.red {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            animation: pulse 1.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #startBtn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #startBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(102, 126, 234, 0.6);
        }

        #startBtn:active {
            transform: translateY(0);
        }

        #startBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 14px;
            color: #666;
        }

        .info strong {
            color: #333;
        }

        .log {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 13px;
            color: #666;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .error {
            color: #f45c43;
            font-weight: bold;
        }

        .success {
            color: #38ef7d;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Sistema Presenze NFC</h1>
        
        <div id="statusCircle" class="status-circle waiting">
            Avvicina il badge
        </div>

        <button id="startBtn">Avvia Lettura NFC</button>

        <div class="info">
            <strong>UID:</strong> <span id="uidDisplay">-</span><br>
            <strong>Stato precedente:</strong> <span id="beforeState">-</span><br>
            <strong>Stato nuovo:</strong> <span id="afterState">-</span>
        </div>

        <div class="log" id="logArea"></div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:5000/nfc'; // Modifica con l'IP del tuo server
        const RELOAD_DELAY = 3000; // Millisecondi prima del reload in caso di errore critico
        
        const statusCircle = document.getElementById('statusCircle');
        const startBtn = document.getElementById('startBtn');
        const uidDisplay = document.getElementById('uidDisplay');
        const beforeState = document.getElementById('beforeState');
        const afterState = document.getElementById('afterState');
        const logArea = document.getElementById('logArea');

        let isProcessing = false;
        let ndefReader = null;

        // Gestione errori globale
        window.addEventListener('error', (event) => {
            log(`‚ö†Ô∏è Errore critico: ${event.message}`, 'error');
            handleCriticalError('Errore JavaScript non gestito');
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`‚ö†Ô∏è Promise rifiutata: ${event.reason}`, 'error');
            handleCriticalError('Errore Promise non gestito');
        });

        function handleCriticalError(message) {
            log(`üîÑ Ricarico la pagina in ${RELOAD_DELAY/1000} secondi...`, 'error');
            statusCircle.textContent = 'ERRORE - Riavvio...';
            statusCircle.className = 'status-circle red';
            
            setTimeout(() => {
                location.reload();
            }, RELOAD_DELAY);
        }

        function log(message, type = 'info') {
            try {
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                const timestamp = new Date().toLocaleTimeString('it-IT');
                entry.textContent = `[${timestamp}] ${message}`;
                logArea.insertBefore(entry, logArea.firstChild);
                
                // Mantieni solo gli ultimi 10 log
                while (logArea.children.length > 10) {
                    logArea.removeChild(logArea.lastChild);
                }
            } catch (err) {
                console.error('Errore nel logging:', err);
            }
        }

        function updateDisplay(state) {
            statusCircle.className = 'status-circle';
            
            if (state === '0') {
                statusCircle.classList.add('red');
                statusCircle.textContent = 'ASSENTE';
            } else if (state === '1') {
                statusCircle.classList.add('green');
                statusCircle.textContent = 'PRESENTE';
            } else {
                statusCircle.classList.add('waiting');
                statusCircle.textContent = 'Avvicina il badge';
            }
        }

        async function readNDEF(tag) {
            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                
                // Leggi i record NDEF
                const records = tag.message?.records || [];
                let currentState = null;
                
                for (const record of records) {
                    if (record.recordType === "text") {
                        const textDecoder = new TextDecoder(record.encoding || "utf-8");
                        const text = textDecoder.decode(record.data);
                        // Cerca uno stato (0 o 1)
                        if (text === '0' || text === '1') {
                            currentState = text;
                            break;
                        }
                    }
                }
                
                return currentState;
            } catch (err) {
                log(`Errore lettura NDEF: ${err.message}`, 'error');
                throw new Error(`Lettura NDEF fallita: ${err.message}`);
            }
        }

        async function writeNDEF(newState) {
            try {
                const ndef = new NDEFReader();
                await ndef.write({
                    records: [{
                        recordType: "text",
                        data: newState
                    }]
                });
                log(`‚úì Scritto nuovo stato: ${newState}`, 'success');
                return true;
            } catch (err) {
                log(`‚úó Errore scrittura NDEF: ${err.message}`, 'error');
                throw new Error(`Scrittura NDEF fallita: ${err.message}`);
            }
        }

        async function handleNFCTag(event) {
            // Previeni elaborazioni multiple simultanee
            if (isProcessing) {
                log('‚ö†Ô∏è Elaborazione gi√† in corso, ignoro il tag', 'error');
                return;
            }

            isProcessing = true;

            try {
                const tag = event;
                const uid = tag.serialNumber;

                if (!uid) {
                    throw new Error('UID del tag non valido');
                }
                
                log(`Tag rilevato: ${uid}`);
                uidDisplay.textContent = uid;

                // 1. Leggi stato corrente dal tag NDEF
                const tagState = await readNDEF(tag);
                log(`Stato letto dal tag: ${tagState || 'non trovato'}`);
                beforeState.textContent = tagState || 'N/A';

                // 2. Invia UID al server con timeout
                log('Contatto il server...');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 sec timeout

                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ UID: uid }),
                    signal: controller.signal
                }).catch(err => {
                    if (err.name === 'AbortError') {
                        throw new Error('Timeout connessione server (5s)');
                    }
                    throw err;
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.DOPO) {
                    throw new Error('Risposta server non valida (manca DOPO)');
                }

                log(`Server risponde - PRIMA: ${data.PRIMA}, DOPO: ${data.DOPO}`, 'success');
                
                afterState.textContent = data.DOPO || 'N/A';

                // 3. Verifica se lo stato √® cambiato
                if (tagState !== data.DOPO) {
                    log(`Aggiornamento necessario: ${tagState} ‚Üí ${data.DOPO}`);
                    // 4. Scrivi nuovo stato sul tag
                    await writeNDEF(data.DOPO);
                } else {
                    log('Stato gi√† sincronizzato, nessun aggiornamento necessario');
                }

                // 5. Mostra il risultato visivo
                updateDisplay(data.DOPO);

                // Reset dopo 3 secondi
                setTimeout(() => {
                    updateDisplay(null);
                    uidDisplay.textContent = '-';
                    beforeState.textContent = '-';
                    afterState.textContent = '-';
                    isProcessing = false;
                }, 3000);

            } catch (err) {
                log(`‚ùå Errore durante elaborazione: ${err.message}`, 'error');
                statusCircle.textContent = 'ERRORE';
                statusCircle.className = 'status-circle red';
                
                // Se √® un errore critico, ricarica la pagina
                if (err.message.includes('Timeout') || 
                    err.message.includes('non valido') || 
                    err.message.includes('Server error')) {
                    handleCriticalError(err.message);
                } else {
                    // Per errori minori, riprova dopo 3 secondi
                    setTimeout(() => {
                        updateDisplay(null);
                        isProcessing = false;
                    }, 3000);
                }
            }
        }

        startBtn.addEventListener('click', async () => {
            if (!('NDEFReader' in window)) {
                log('NFC non supportato su questo dispositivo', 'error');
                handleCriticalError('NFC non supportato - Usa Chrome su Android');
                return;
            }

            try {
                startBtn.disabled = true;
                startBtn.textContent = 'Lettura attiva...';
                log('Sistema NFC attivato', 'success');

                ndefReader = new NDEFReader();
                await ndefReader.scan();

                log('‚úì In attesa di tag NFC...', 'info');

                ndefReader.addEventListener("reading", handleNFCTag);
                
                ndefReader.addEventListener("readingerror", (err) => {
                    log(`‚ö†Ô∏è Errore lettura NFC: ${err}`, 'error');
                    handleCriticalError('Errore critico nella lettura NFC');
                });

            } catch (err) {
                log(`‚ùå Errore attivazione NFC: ${err.message}`, 'error');
                
                if (err.name === 'NotAllowedError') {
                    handleCriticalError('Permessi NFC negati');
                } else if (err.name === 'NotSupportedError') {
                    handleCriticalError('NFC non supportato su questo dispositivo');
                } else {
                    handleCriticalError(`Errore NFC: ${err.message}`);
                }
            }
        });

        // Log iniziale
        log('‚úì App pronta. Premi il pulsante per iniziare.');
    </script>
</body>
</html>
